<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>创建派工计划</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="js/layui-main/dist/css/layui.css">
    <style>
        body {
            padding: 20px;
        }
        .plan-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .plan-row .form-control {
            margin-right: 10px;
        }
        .plan-row .btn {
            flex-shrink: 0;
        }
    </style>
</head>
<body>

<form id="dispatchForm">
    <input type="hidden" id="customerOrderId" name="customerOrderId">
    <input type="hidden" id="moNo" name="moNo">

    <h4>
        为制令单号: <span id="moNoDisplay"></span> 创建派工计划 <br>
        <small>单个模具生产的最小数量: <span id="minMoldQtyDisplay" class="text-danger">查询中...</span></small>
    </h4>
    <hr>

    <div id="planRowsContainer">
        <!-- 动态行将在这里创建 -->
    </div>

    <button type="submit" class="btn btn-primary">提交计划</button>
</form>

<!-- 行模板 -->
<div id="rowTemplate" style="display: none;">
    <div class="plan-row">
        <input type="date" class="form-control" name="planDate" required>
        <input type="number" class="form-control" name="planQuantity" placeholder="计划数量" min="1" required>
        <input type="number" class="form-control" name="moldQuantity" placeholder="模具数量" min="1" required>
        <button type="button" class="btn btn-success btn-sm add-row-btn">+</button>
        <button type="button" class="btn btn-danger btn-sm remove-row-btn">-</button>
    </div>
</div>


<script src="js/jquery v3.5.1.min.js"></script>
<script src="js/layui-main/dist/layui.js"></script>

<script>
    layui.use(['layer', 'laydate'], function() {
        var layer = layui.layer;
        var laydate = layui.laydate;

        // 初始化
        $(document).ready(function() {
            var urlParams = new URLSearchParams(window.location.search);
            var customerOrderId = urlParams.get('customerOrderId');
            var moNo = urlParams.get('moNo');
            var moldDrawingNo = urlParams.get('moldDrawingNo');

            $('#customerOrderId').val(customerOrderId);
            $('#moNo').val(moNo);
            $('#moNoDisplay').text(moNo);

            loadMinQty(moldDrawingNo);
            loadExistingPlans(moNo);
        });

        function loadMinQty(moldDrawingNo) {
            if (!moldDrawingNo || moldDrawingNo === 'null') {
                $('#minMoldQtyDisplay').text('无模具图号');
                return;
            }
            $.ajax({
                url: 'http://192.168.0.168:8080/nextal/mold/minQty',
                type: 'GET',
                data: { moldDrawingNo: moldDrawingNo },
                success: function(response) {
                    if (response.code === 0) {
                        $('#minMoldQtyDisplay').text(response.data || '未找到');
                    } else {
                        $('#minMoldQtyDisplay').text('查询失败');
                    }
                },
                error: function() {
                    $('#minMoldQtyDisplay').text('查询出错');
                }
            });
        }

        function loadExistingPlans(moNo) {
            $.ajax({
                url: 'http://192.168.0.168:8080/nextal/orderPlan/list',
                type: 'GET',
                data: { moNo: moNo },
                success: function(response) {
                    if (response.code === 0 && response.data && response.data.length > 0) {
                        response.data.forEach(function(plan) {
                            addRow(plan);
                        });
                    } else {
                        addRow();
                    }
                },
                error: function() {
                    layer.msg('加载已有计划失败', {icon: 2});
                    addRow();
                }
            });
        }

        function addRow(plan) {
            var newRow = $($('#rowTemplate').html());
            
            if (plan) {
                var planDate = new Date(plan.planDate).toISOString().split('T')[0];
                newRow.find('input[name="planDate"]').val(planDate);
                newRow.find('input[name="planQuantity"]').val(plan.planQuantity);
                newRow.find('input[name="moldQuantity"]').val(plan.moldQuantity);
            }

            $('#planRowsContainer').append(newRow);

            var newDateInput = newRow.find('input[name="planDate"]');
            laydate.render({
                elem: newDateInput[0],
                done: function(value) { $(this.elem).val(value); }
            });
        }

        $('#planRowsContainer').on('click', '.add-row-btn', function() { addRow(); });

        $('#planRowsContainer').on('click', '.remove-row-btn', function() {
            if ($('.plan-row').length > 1) {
                $(this).closest('.plan-row').remove();
            } else {
                layer.msg('至少需要一个派工计划', {icon: 5});
            }
        });

        $('#dispatchForm').on('submit', function(e) {
            e.preventDefault();

            var plans = [];
            var customerOrderId = $('#customerOrderId').val();
            var moNo = $('#moNo').val();
            var isValid = true;

            $('#planRowsContainer .plan-row').each(function() {
                var planDate = $(this).find('input[name="planDate"]').val();
                var planQuantity = $(this).find('input[name="planQuantity"]').val();
                var moldQuantity = $(this).find('input[name="moldQuantity"]').val();

                if (!planDate || !planQuantity || !moldQuantity) {
                    isValid = false;
                    return false;
                }

                plans.push({
                    customerOrderId: parseInt(customerOrderId),
                    moNo: moNo,
                    planDate: planDate,
                    planQuantity: parseInt(planQuantity),
                    moldQuantity: parseInt(moldQuantity)
                });
            });

            if (!isValid) {
                layer.msg('请填写所有日期、计划数量和模具数量', {icon: 2});
                return;
            }
            
            if (plans.length === 0) {
                layer.msg('请至少添加一个派工计划', {icon: 2});
                return;
            }

            $.ajax({
                url: 'http://192.168.0.168:8080/nextal/orderPlan/batchCreate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(plans),
                success: function(response) {
                    if (response.code === 0) {
                        layer.msg('派工计划保存成功!', {icon: 1, time: 2000}, function() {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                    } else {
                        layer.msg(response.message || '保存失败', {icon: 2});
                    }
                },
                error: function() {
                    layer.msg('请求失败，请检查网络或联系管理员', {icon: 2});
                }
            });
        });
    });
</script>

</body>
</html>
